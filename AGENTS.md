# AGENTS.md - Guide for AI Agents Working on nixified-ai

## Repository Overview

**nixified-ai** is a Nix Flake repository that provides reproducible, sandboxed AI software packages, primarily focused on **ComfyUI** and related AI tools. The goal is to make AI software easy to run while maintaining security, reproducibility, and proper package management.

**Key Principles:**
- **Reproducibility**: Same inputs = same outputs (via Nix)
- **Security**: Sandboxed execution, especially for custom nodes
- **Declarative**: All dependencies explicitly declared
- **No imperative package managers**: No pip, npm, etc. Everything through Nix

## Repository Structure

```
nixifiedai/
├── flake.nix                          # Main flake entry point
├── flake.lock                         # Locked dependency versions
├── flake-modules/                     # Modular flake components
│   ├── default.nix                    # Imports all submodules
│   ├── fetchers/                      # Custom fetchers (fetchResource, fetchair)
│   │   ├── default.nix                # Fetchers overlay
│   │   ├── fetchresource/             # Fetch files with metadata
│   │   └── fetchair/                  # Fetch AI resources from HuggingFace, CivitAI, etc.
│   ├── models/                        # Pre-packaged AI models
│   │   ├── default.nix                # Models overlay
│   │   └── models.nix                 # Model definitions
│   ├── packages/                      # Python packages not in nixpkgs
│   │   ├── autogptq/
│   │   ├── controlnet-aux/
│   │   ├── sageattention/
│   │   └── ...                        # Each has package.nix
│   ├── projects/                      # Main AI projects
│   │   └── comfyui/                   # ComfyUI implementation (main focus)
│   │       ├── default.nix            # ComfyUI flake module & overlays
│   │       ├── module.nix             # NixOS service module
│   │       ├── lib.nix                # Helper functions
│   │       ├── README.md              # Usage documentation
│   │       ├── npins/                 # Version pins for ComfyUI core packages
│   │       │   ├── sources.json       # npins database
│   │       │   └── default.nix        # Generated by npins
│   │       ├── customNodes-npins/     # Version pins for custom nodes
│   │       │   ├── sources.json       # npins database for nodes
│   │       │   └── default.nix        # Generated by npins
│   │       ├── customNodes/           # Custom node package definitions
│   │       │   ├── comfyui-kjnodes/
│   │       │   │   └── package.nix    # Python deps, patches
│   │       │   ├── comfyui-impact-pack/
│   │       │   └── ...                # 37+ custom nodes
│   │       ├── pkgs/                  # ComfyUI core packages
│   │       │   ├── comfyui/           # Main wrapper package
│   │       │   ├── comfyui-unwrapped/ # Core ComfyUI
│   │       │   ├── comfyui-frontend-package/
│   │       │   ├── comfyui-workflow-templates/
│   │       │   └── comfyui-embedded-docs/
│   │       ├── scripts/               # Maintenance scripts
│   │       │   ├── comfyui-update.nix     # Update ComfyUI core
│   │       │   ├── comfyui-nodes-update.nix
│   │       │   ├── comfyui-nodes-npins.nix  # Wrapper for npins
│   │       │   └── comfyui-npins.nix
│   │       ├── template/              # Non-NixOS template
│   │       └── vm-test/               # Integration tests
│   ├── deprecations/                  # Deprecated project warnings
│   └── website/                       # Documentation website
└── AUTHORS                            # Contributors
```

## Core Concepts

### 1. **Flake-Parts Architecture**

This repo uses `flake-parts` for modular flake composition. Each module in `flake-modules/` contributes:
- **Overlays**: Add packages to nixpkgs
- **Packages**: Expose packages via `packages.<system>.<name>`
- **NixOS Modules**: Provide system services
- **Templates**: Scaffold new configurations

Import order: `flake.nix` → `flake-modules/default.nix` → submodules

### 2. **npins - Dependency Pinning**

**What is npins?**
- Lightweight alternative to Niv or flake inputs
- Stores pinned versions in `sources.json`
- Generates `default.nix` with fetch expressions
- Simpler than flakes for non-flake dependencies

**Two npins databases in ComfyUI:**
1. `npins/sources.json` - Core ComfyUI packages (comfyui, frontend, docs, workflow-templates)
2. `customNodes-npins/sources.json` - Custom nodes (37+ GitHub repos)

**Common operations:**
```bash
# List all pins
nix run .#nixified-ai.internal.comfyui-npins -- show
nix run .#nixified-ai.internal.comfyui-nodes-npins -- show

# Update a specific pin
nix run .#nixified-ai.internal.comfyui-npins -- update comfyui
nix run .#nixified-ai.internal.comfyui-nodes-npins -- update comfyui-kjnodes

# Update all pins
nix run .#nixified-ai.internal.comfyui-npins -- update
nix run .#nixified-ai.internal.comfyui-nodes-npins -- update

# Add a new pin
nix run .#nixified-ai.internal.comfyui-nodes-npins -- add github owner repo

# Remove a pin
nix run .#nixified-ai.internal.comfyui-nodes-npins -- remove comfyui-somename
```

### 3. **Overlays System**

The repo provides three main overlays:

#### `overlays.comfyui`
Adds to nixpkgs:
- `comfyuiNpins` - Data from `npins/sources.json`
- `customCustomNodesPins` - Data from `customNodes-npins/sources.json`
- `comfyuiLib` - Helper functions
- `comfyuiPackages` - All ComfyUI packages + custom nodes
- `comfyui` - Alias for `comfyuiPackages.comfyui`
- `python3Packages` - Overlay with extra Python packages from `flake-modules/packages/`

#### `overlays.models`
Adds `nixified-ai.models.*` - Pre-packaged AI models

#### `overlays.fetchers`
Adds `fetchResource` and `fetchair` - Custom fetchers for AI resources

### 4. **Package Organization**

#### Python Packages (`flake-modules/packages/`)
- Custom Python packages not in nixpkgs
- Auto-imported into `python3Packages` overlay
- Each has `package.nix` following `buildPythonPackage` conventions

#### ComfyUI Core Packages (`flake-modules/projects/comfyui/pkgs/`)
- `comfyui-unwrapped` - Base ComfyUI from npins
- `comfyui-frontend-package` - Web UI
- `comfyui-workflow-templates` - Template workflows (with inline dependencies)
- `comfyui` - Wrapper that combines everything

#### Custom Nodes (`flake-modules/projects/comfyui/customNodes/`)
- Automatically built from `customNodes-npins/sources.json`
- Optional `package.nix` adds Python dependencies or patches
- Format:
  ```nix
  {
    python3Packages,
  }:
  {
    pname = "comfyui-kjnodes";  # Must match npins entry (lowercase, hyphens)
    # GitHub: owner/ComfyUI-KJNodes → npins: comfyui-kjnodes
    pyproject = false;
    propagatedBuildInputs = with python3Packages; [
      numpy
      pillow
    ];
  }
  ```

## Common Tasks

### Updating ComfyUI Core

**Process:**
1. Run npins update:
   ```bash
   nix run .#nixified-ai.internal.comfyui-update
   ```

2. This updates `flake-modules/projects/comfyui/npins/sources.json`

3. Build and test:
   ```bash
   nix build .#comfyui-nvidia
   ```

4. If build fails, check for:
   - New Python dependencies needed
   - Breaking changes in package structure (e.g., workflow-templates v0.3.0+)
   - Missing system dependencies

5. Fix by:
   - Adding Python packages to `flake-modules/packages/`
   - Modifying `pkgs/*/package.nix` files
   - Creating inline package builds if needed (see workflow-templates example)

### Adding a Custom Node

**IMPORTANT:** Two-step process:
1. **Add to npins** → Makes node *available* in repo
2. **Add to default.nix** → Actually *includes* it in build

Nodes in `customNodes-npins/sources.json` are NOT automatically included!

**Method 1: Node already exists (most common)**

Edit `flake-modules/projects/comfyui/default.nix` line ~115:

```nix
comfyui-nvidia = nvidiaPkgs.comfyuiPackages.comfyui.override {
  withCustomNodes = with nvidiaPkgs.comfyuiPackages; [
    comfyui-kjnodes
    comfyui-impact-pack
    # Add more here
  ];
} // {
```

**Method 2: Add a new node to the repo**

1. Add to npins (GitHub repo `owner/ComfyUI-Name` → `comfyui-name`):
   ```bash
   nix run .#nixified-ai.internal.comfyui-nodes-npins -- add github owner repo
   # Example: add github numz ComfyUI-SeedVR2_VideoUpscaler
   # Creates: comfyui-seedvr2-videoupscaler
   ```

2. Check if Python deps needed:
   ```bash
   curl -s https://raw.githubusercontent.com/owner/repo/main/requirements.txt
   # Check which packages are missing from nixpkgs:
   nix eval nixpkgs#python3Packages.<pkg-name>.version 2>&1 | grep error
   ```

3. If deps needed, create `flake-modules/projects/comfyui/customNodes/comfyui-<name>/package.nix`:
   ```nix
   { python3Packages }:
   {
     pname = "comfyui-seedvr2-videoupscaler";  # MUST match npins entry (lowercase, hyphens)
     pyproject = false;
     propagatedBuildInputs = with python3Packages; [
       torch torchvision numpy pillow
     ];
   }
   ```

4. Enable in `default.nix` (see Method 1)

5. Build and test:
   ```bash
   nix build .#comfyui-nvidia
   ls result/lib/python*/site-packages/custom_nodes/  # Verify node present
   ```

6. Commit changes:
   - `customNodes-npins/sources.json`
   - `customNodes/comfyui-<name>/package.nix` (if created)
   - `default.nix` (if enabling by default)

### Adding a Python Package

**When:** ComfyUI or a custom node needs a Python package not in nixpkgs.

**Process:**
1. Create `flake-modules/packages/<package-name>/package.nix`:
   ```nix
   {
     lib,
     buildPythonPackage,
     fetchPypi,
     setuptools,
     # ... dependencies
   }:
   buildPythonPackage rec {
     pname = "package-name";
     version = "1.0.0";
     
     src = fetchPypi {
       inherit pname version;
       hash = "sha256-...";  # Use lib.fakeHash first
     };
     
     format = "pyproject";  # or "setuptools"
     
     build-system = [ setuptools ];
     
     dependencies = [
       # runtime deps
     ];
     
     pythonImportsCheck = [ "package_name" ];
     
     meta = {
       description = "...";
       homepage = "...";
       license = lib.licenses.mit;
     };
   }
   ```

2. Build to get correct hash:
   ```bash
   nix build .#comfyui-nvidia
   # Copy the hash from error message
   ```

3. The package automatically becomes available in `python3Packages.package-name`

### Handling Breaking Changes

**Example: comfyui-workflow-templates v0.3.0+**

The package split into 5 sub-packages. Solution: inline builds in `package.nix`:

```nix
let
  # Helper to reduce boilerplate
  buildTemplatePackage = { pname, version, hash, dependencies ? [] }: ...;
  
  core = buildTemplatePackage { ... };
  media-api = buildTemplatePackage { dependencies = [ core ]; ... };
  media-video = buildTemplatePackage { dependencies = [ core media-api ]; ... };
  # ... etc
in
python3Packages.callPackage ({...}:
  buildPythonPackage {
    dependencies = [ core media-api media-video media-image media-other ];
    # ...
  }
) { }
```

**Why inline?** Avoids circular dependency between `comfyuiPackages` and `python3Packages` scopes.

## Nix Conventions to Follow

### 1. **Always use npins for version tracking**
- Never hardcode git commits in `.nix` files
- Use npins to track GitHub repos, PyPI packages, etc.
- This ensures `nix flake update` works correctly

### 2. **Preserve reproducibility**
- Always include full hashes (`sha256-...`)
- Pin exact versions (via npins or in package.nix)
- Avoid `fetchLatest`, `fetchFromGitHub` without rev, etc.

### 3. **Use overlays, not direct imports**
- Custom packages should be added via overlays
- This allows users to override them easily
- Don't do: `import ./foo.nix`
- Do: Add to overlay, use `pkgs.foo`

### 4. **Follow nixpkgs Python conventions**
- Use `buildPythonPackage` from `python3Packages`
- Use `format = "pyproject"` for modern packages
- Use `build-system`, `dependencies`, `optional-dependencies` (not `buildInputs`)
- Always include `pythonImportsCheck`

### 5. **Minimal dependencies**
- Only add dependencies that are actually needed
- Use `propagatedBuildInputs` for runtime deps
- Use `nativeBuildInputs` for build tools
- Use `build-system` for PEP 517 build backends

### 6. **Proper meta attributes**
- Always include: `description`, `homepage`, `license`
- Add `maintainers` if appropriate
- Use `lib.licenses.*` constants

### 7. **Test your changes**
- Build: `nix build .#comfyui-nvidia`
- Verify nodes: `ls result/lib/python*/site-packages/custom_nodes/`
- Run: `./result/bin/comfyui`
- Check WebUI: Right-click → "Add Node" → search for your node
- Check console: Look for "Loaded X custom nodes" and no import errors

### 8. **Clear commit messages**
Format: `<component>: <action> <what> [details]`

Examples:
```
comfyui: update to v0.3.77 and fix workflow-templates dependencies
comfyui: add comfyui-kjnodes custom node
packages: add sageattention Python package
comfyui: enable kjnodes and impact-pack by default
```

## Build System Details

### How `comfyui-nvidia` is built:

1. **Base**: `comfyui-unwrapped` (from npins)
   - Pure ComfyUI source
   - Python dependencies
   - No models, no custom nodes

2. **Wrapped**: `comfyui` package (from `pkgs/comfyui/package.nix`)
   - Takes `withCustomNodes` and `withModels` arguments
   - Uses `symlinkJoin` to combine:
     - `comfyui-unwrapped`
     - Custom nodes (symlinked into `custom_nodes/`)
     - Models (symlinked into `models/*/`)
   - Generates `extra_model_paths.yaml`
   - Creates wrapper script with proper env vars

3. **Exposed**: `packages.comfyui-nvidia`
   - CUDA-enabled pkgs
   - Default custom nodes (if specified in `default.nix`)
   - Passthru for accessing `comfyuiPackages`

### Custom nodes are installed by:
- Symlinking node directories into `lib/python3.x/site-packages/custom_nodes/`
- ComfyUI auto-discovers them on startup
- Node `__init__.py` registers nodes with ComfyUI

### Models are installed by:
- Creating `linkFarm` of all model files
- Organizing by type: `models/checkpoints/`, `models/loras/`, etc.
- `extra_model_paths.yaml` tells ComfyUI where to find them

## Debugging Tips

### Build fails with "hash mismatch"
- Copy the `got:` hash from error
- Update `hash = "sha256-..."` in package.nix
- Rebuild

### Build fails with "No module named 'foo'"
- Python package missing
- Add to `flake-modules/packages/foo/package.nix`
- Or add to existing package's `dependencies`

### Custom node not appearing in ComfyUI
- **Most common**: Node in `customNodes-npins/sources.json` but NOT in `default.nix` withCustomNodes list
- Check it's in `withCustomNodes` list in `default.nix`
- Verify: `ls result/lib/python*/site-packages/custom_nodes/` contains the node
- Run ComfyUI and check console for import errors

### Can't find models
- Models need `passthru.comfyui.installPaths` metadata
- Check `extra_model_paths.yaml` in ComfyUI data dir
- Verify model files are in `result/lib/python*/site-packages/models/*/`

### npins command not found
- Use: `nix run .#nixified-ai.internal.comfyui-nodes-npins -- <command>`
- Or install: `nix profile install nixpkgs#npins`

## Important Files Reference

### For updating ComfyUI core:
- `flake-modules/projects/comfyui/npins/sources.json` - Version pins
- `flake-modules/projects/comfyui/pkgs/comfyui-unwrapped/package.nix` - Core package
- `flake-modules/projects/comfyui/pkgs/comfyui-workflow-templates/package.nix` - Often breaks

### For adding custom nodes:
- `flake-modules/projects/comfyui/customNodes-npins/sources.json` - Add node here
- `flake-modules/projects/comfyui/customNodes/<name>/package.nix` - Optional overrides
- `flake-modules/projects/comfyui/default.nix` - Enable by default (line 115)

### For adding Python packages:
- `flake-modules/packages/<name>/package.nix` - Package definition
- Auto-imported into `python3Packages` overlay

### For testing:
- `flake-modules/projects/comfyui/vm-test/` - Integration tests
- Build with: `nix build .#checks.x86_64-linux.comfyui`

## Quick Reference Commands

```bash
# List all available custom nodes in repo
nix run .#nixified-ai.internal.comfyui-nodes-npins -- show

# List nodes currently enabled in default build
grep -A5 "withCustomNodes" flake-modules/projects/comfyui/default.nix

# Check if Python package exists in nixpkgs
nix eval nixpkgs#python3Packages.<package-name>.version

# Verify custom nodes in build
ls result/lib/python*/site-packages/custom_nodes/
```

## Example Workflow: Updating ComfyUI

Complete example of updating from v0.3.65 to v0.3.77:

1. **Update pins:**
   ```bash
   nix run .#nixified-ai.internal.comfyui-update
   ```

2. **Build to find issues:**
   ```bash
   nix build .#comfyui-nvidia
   # ERROR: ModuleNotFoundError: No module named 'comfyui_workflow_templates_core'
   ```

3. **Investigate:**
   - Check PyPI: `comfyui-workflow-templates` now requires 4 new packages
   - These are `comfyui-workflow-templates-{core,media-api,media-video,media-image,media-other}`

4. **Fix by adding inline builds:**
   Edit `flake-modules/projects/comfyui/pkgs/comfyui-workflow-templates/package.nix`:
   - Create helper function `buildTemplatePackage`
   - Build all 5 packages inline
   - Add to main package's `dependencies`

5. **Get correct hashes:**
   ```bash
   nix-prefetch-url <pypi-url> | xargs nix hash to-sri --type sha256
   ```

6. **Test:**
   ```bash
   nix build .#comfyui-nvidia
   ./result/bin/comfyui
   ```

7. **Commit:**
   ```bash
   git add flake-modules/projects/comfyui/
   git commit -m "comfyui: update to v0.3.77 and fix workflow-templates dependencies"
   ```

## Resources

- **Nix Pills**: https://nixos.org/guides/nix-pills/
- **nixpkgs manual**: https://nixos.org/manual/nixpkgs/stable/
- **flake-parts docs**: https://flake.parts/
- **npins**: https://github.com/andir/npins
- **ComfyUI repo**: https://github.com/comfyanonymous/ComfyUI
- **nixified-ai community**: https://matrix.to/#/#nixified.ai:matrix.org

## Final Notes

- **Security matters**: Custom nodes can execute arbitrary code. The NixOS module sandboxes ComfyUI.
- **Test before committing**: Always build and run ComfyUI after changes.
- **Ask for help**: Join Matrix if you're stuck.
- **Document breaking changes**: Update this file if architecture changes.
- **Be patient**: AI software moves fast, breakage is expected.

---

**Last Updated:** December 2024  
**For questions:** https://matrix.to/#/#nixified.ai:matrix.org
